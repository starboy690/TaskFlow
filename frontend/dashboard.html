<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskFlow - Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: white;
        min-height: 100vh;
      }

      /* Dashboard Header */
      .dashboard-header {
        background-color: rgb(152, 222, 222);
        color: black;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        box-sizing: border-box;
        width: 100%;
      }

      .user-info h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .user-info p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
      }

      .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgb(84, 56, 56);
        color: rgb(9, 9, 9);
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .logout-btn:hover {
        background: rgb(203, 201, 201);
        color: #667eea;
      }

      /* Tablet Devices (768px and below) */
      @media screen and (max-width: 768px) {
        .dashboard-header {
          padding: 15px 20px;
          flex-direction: column;
          text-align: center;
          gap: 20px;
        }

        .user-info h1 {
          font-size: 2rem;
          margin-bottom: 8px;
        }

        .user-info p {
          font-size: 1rem;
        }

        .logout-btn {
          padding: 10px 20px;
          font-size: 0.9rem;
        }
      }

      /* Mobile Devices (480px and below) */
      @media screen and (max-width: 480px) {
        .dashboard-header {
          padding: 12px 15px;
        }

        .user-info h1 {
          font-size: 1.7rem;
          margin-bottom: 5px;
        }

        .user-info p {
          font-size: 0.9rem;
        }

        .logout-btn {
          padding: 8px 16px;
          font-size: 0.85rem;
          width: 100%;
          justify-content: center;
        }
      }

      /* Large Screens (1200px and above) */
      @media screen and (min-width: 1200px) {
        .dashboard-header {
          padding: 30px 50px;
        }

        .user-info h1 {
          font-size: 3rem;
        }

        .user-info p {
          font-size: 1.2rem;
        }
      }

      /* Extra Small Devices (360px and below) */
      @media screen and (max-width: 360px) {
        .dashboard-header {
          padding: 10px 12px;
        }

        .user-info h1 {
          font-size: 1.5rem;
        }

        .user-info p {
          font-size: 0.85rem;
        }

        .logout-btn {
          padding: 6px 12px;
          font-size: 0.8rem;
        }
      }

      /* Landscape Mobile */
      @media screen and (max-height: 500px) and (orientation: landscape) {
        .dashboard-header {
          padding: 15px 20px;
        }

        .user-info h1 {
          font-size: 1.8rem;
          margin-bottom: 5px;
        }
      }

      /* Navigation Section */
      .section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 80px;
        background-color: #f9f9f9;
        padding: 40px;
      }

      .section .display {
        display: flex;
        gap: 20px;
      }

      .icon-text {
        text-align: center;
        max-width: 250px;
        border: 0.6px solid #ccc;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        height: 26px;
        gap: 5px;
        display: flex;
        align-items: center;
        justify-content: space-evenly;
        background-color: #f0f0f0;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .icon-text:hover {
        background-color: #e8e8e8;
        transform: translateY(-2px);
      }

      .icon-text.active {
        background-color: #365ee2;
        border-color: #365ee2;
        color: white;
      }

      .icon-text#group.active {
        background-color: #28a745;
        color: white;
        border-color: #28a745;
      }

      .icon-text.active p,
      .icon-text.active i {
        color: white !important;
      }

      .icon-text#group {
        border: none;
        background-color: transparent;
        box-shadow: none;
      }

      .icon-text#group:hover {
        background-color: #e0e0e0;
      }

      .icon-text p {
        font-size: 16px;
        color: #555;
        margin: 0;
        font-weight: 500;
      }

      .icon-text i {
        color: #666;
        transition: color 0.3s ease;
      }

      .add button {
        background-color: #365ee2;
        border: none;
        border-radius: 14px;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        width: 150px;
        height: 42px;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .add button:hover {
        background-color: #274bb5;
        transform: translateY(-2px);
      }

      /* Task Section */
      /* Main Task Section */
      .task-section {
        padding: 20px;
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
      }

      .task-section h1 {
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 28px;
      }

      .task-section > p {
        color: #7f8c8d;
        margin-bottom: 30px;
        font-size: 16px;
      }

      /* Cards Container */
      .cards {
        display: flex;
        gap: 25px;
        min-height: 600px;
        justify-content: space-between;
      }

      /* Individual Task Display Column */
      .tasks-display {
        border: 1px solid #e1e8ed;
        padding: 25px;
        border-radius: 16px;
        width: 32%; /* Three equal columns */
        background: white;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        min-height: 585px;
        height: auto;
        overflow: visible;
        position: relative;
      }

      .tasks-display:hover {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        transform: translateY(-5px);
      }

      /* Column Headers */
      .tasks-display h5 {
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
        margin: 0 0 25px 0;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f2f5;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .tasks-display h5 span {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #f8f9fa;
      }

      .tasks-display h5 .task-count {
        background: #e9ecef;
        color: #6c757d;
        font-size: 14px;
        padding: 2px 10px;
        border-radius: 12px;
        margin-left: auto;
      }

      /* Tasks Container - Auto-adjusting layout */
      .tasks-container {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr;
        gap: 18px;
        min-height: 450px;
        padding: 5px;
        padding-right: 8px;
        overflow-y: auto;
        transition: all 0.3s ease;
      }

      /* Scrollbar for tasks container */
      .tasks-container::-webkit-scrollbar {
        width: 6px;
      }

      .tasks-container::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 10px;
      }

      .tasks-container::-webkit-scrollbar-thumb {
        background: #d1d9e0;
        border-radius: 10px;
      }

      .tasks-container::-webkit-scrollbar-thumb:hover {
        background: #a8b5c1;
      }

      /* Auto-adjusting layouts based on task count */
      .tasks-container:has(.task-item:nth-child(2)) {
        grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
      }

      .tasks-container:has(.task-item:nth-child(3)) {
        grid-template-columns: repeat(auto-fill, minmax(48%, 1fr));
      }

      .tasks-container:has(.task-item:nth-child(5)) {
        grid-template-columns: repeat(auto-fill, minmax(45%, 1fr));
        gap: 15px;
      }

      .tasks-container:has(.task-item:nth-child(7)) {
        grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
        gap: 12px;
      }

      /* Empty State */
      .tasks-container .empty {
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: #95a5a6;
        font-style: italic;
        padding: 60px 20px;
        min-height: 400px;
        grid-column: 1 / -1;
        font-size: 15px;
        background: #fafbfc;
        border-radius: 12px;
        border: 2px dashed #e1e8ed;
      }

      /* Individual Task Item */
      .task-item {
        background: white;
        border-radius: 14px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        cursor: pointer;
        border-left: 5px solid;
        display: flex;
        flex-direction: column;
        min-height: 140px;
        position: relative;
        overflow: hidden;
        border: 1px solid #f0f2f5;
      }

      .task-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: #e1e8ed;
      }

      /* Priority border colors */
      .task-item.priority-low {
        border-left-color: #28a745;
      }
      .task-item.priority-medium {
        border-left-color: #ffc107;
      }
      .task-item.priority-high {
        border-left-color: #dc3545;
      }

      /* Task Header */
      .task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }

      .task-title {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
        flex: 1;
        line-height: 1.4;
        word-break: break-word;
      }

      .task-actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .task-item:hover .task-actions {
        opacity: 1;
      }

      .btn-task-edit,
      .btn-task-delete {
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        font-size: 15px;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
      }

      .btn-task-edit:hover {
        background: #e3f2fd;
        color: #1976d2;
      }

      .btn-task-delete:hover {
        background: #ffebee;
        color: #d32f2f;
      }

      /* Task Description */
      .task-description {
        color: #5a6c7d;
        font-size: 14px;
        margin: 0 0 18px 0;
        line-height: 1.5;
        flex-grow: 1;
        word-break: break-word;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* Task Meta Information */
      .task-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 12px;
        color: #7f8c8d;
        margin-bottom: 18px;
      }

      .task-group,
      .task-assignee,
      .task-due {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        background: #f8f9fa;
        border-radius: 8px;
        font-weight: 500;
      }

      .task-due.overdue {
        background: #fee;
        color: #dc3545;
        font-weight: 600;
      }

      .task-group i,
      .task-assignee i,
      .task-due i {
        font-size: 11px;
      }

      /* Task Footer */
      .task-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
        padding-top: 16px;
        border-top: 1px solid #f0f2f5;
      }

      .task-priority {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .task-priority.low {
        background: #d4edda;
        color: #155724;
      }
      .task-priority.medium {
        background: #fff3cd;
        color: #856404;
      }
      .task-priority.high {
        background: #f8d7da;
        color: #721c24;
      }

      .task-status-actions {
        display: flex;
        gap: 8px;
      }

      .btn-status {
        padding: 7px 14px;
        border: none;
        border-radius: 8px;
        background: #edf2f7;
        color: #4a5568;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .btn-status:hover {
        background: #e2e8f0;
        transform: translateY(-1px);
      }

      /* To Do column specific */
      .tasks-display:nth-child(1) .btn-status {
        background: #e3f2fd;
        color: #1976d2;
      }

      /* In Progress column specific */
      .tasks-display:nth-child(2) .btn-status {
        background: #fff3cd;
        color: #856404;
      }

      /* Completed column specific */
      .tasks-display:nth-child(3) .btn-status {
        background: #d4edda;
        color: #155724;
      }

      /* Column-specific border accents */
      .tasks-display:nth-child(1) {
        /* To Do */
        border-top: 4px solid rgba(223, 203, 113, 0.848);
      }

      .tasks-display:nth-child(2) {
        /* In Progress */
        border-top: 4px solid rgb(232, 144, 37);
      }

      .tasks-display:nth-child(3) {
        /* Completed */
        border-top: 4px solid greenyellow;
      }

      /* Responsive Design */
      @media (max-width: 1200px) {
        .cards {
          flex-wrap: wrap;
        }

        .tasks-display {
          width: 48%;
          min-height: 550px;
        }
      }

      @media (max-width: 768px) {
        .cards {
          flex-direction: column;
        }

        .tasks-display {
          width: 100%;
          min-height: 500px;
          margin-bottom: 20px;
        }

        .tasks-container {
          min-height: 350px;
        }

        .task-item {
          padding: 16px;
        }

        .task-meta {
          flex-direction: column;
          gap: 8px;
        }
      }

      @media (max-width: 480px) {
        .task-section {
          padding: 15px;
        }

        .tasks-display {
          padding: 18px;
        }

        .task-header {
          flex-direction: column;
          gap: 10px;
        }

        .task-actions {
          opacity: 1;
          align-self: flex-end;
        }

        .btn-status {
          padding: 6px 10px;
          font-size: 11px;
        }
      }

      /* Animation for new tasks */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .task-item {
        animation: slideIn 0.4s ease forwards;
      }

      /* Smooth height transition for columns */
      .tasks-display {
        transition: height 0.4s ease, transform 0.3s ease;
      }

      /* Make column expand when tasks are added */
      .tasks-display:has(.task-item) {
        height: auto;
      }
      /* Group Section */
      .group-section {
        padding: 40px;
      }

      .groups-display {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        text-align: center;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .groups-display .empty {
        color: rgba(255, 255, 255, 0.9) !important;
        font-size: 1.1rem;
        border: 2px dashed rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        margin-top: 10px;
      }

      /* Group Items Styling */
      .group-item {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid #e9ecef;
        border-left: 5px solid #365ee2;
        width: 100%;
        max-width: 800px;
      }

      .group-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-color: #365ee2;
      }

      .group-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
        border-bottom: 1px solid #f1f3f4;
        padding-bottom: 12px;
      }

      .group-item-header h5 {
        margin: 0;
        color: #2c3e50;
        font-size: 1.3rem;
        font-weight: 600;
        flex: 1;
      }

      .member-count {
        background: #365ee2;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        min-width: 70px;
        text-align: center;
      }

      .group-description {
        color: #7f8c8d;
        margin: 15px 0;
        line-height: 1.5;
        font-size: 0.95rem;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 3px solid #bdc3c7;
      }

      .group-item-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #f1f3f4;
      }

      .group-role {
        color: #7f8c8d;
        font-size: 0.9rem;
      }

      .group-role strong {
        color: #365ee2;
        text-transform: capitalize;
        padding: 4px 8px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }

      .invitation-code {
        background: #e8f4fd;
        color: #1976d2;
        padding: 6px 12px;
        border-radius: 6px;
        font-family: "Courier New", monospace;
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px dashed #1976d2;
      }

      .group-actions {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        justify-content: center;
      }

      .group-actions button {
        background: #365ee2;
        border: none;
        border-radius: 14px;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        padding: 12px 20px;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .group-actions button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .group-actions button#joinGroupBtn {
        background: #28a745;
      }

      .group-actions button#joinGroupBtn:hover {
        background: #218838;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
      }

      .modal-content.group-management {
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-content.confirmation {
        max-width: 400px;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-50px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        border-bottom: 1px solid #e9ecef;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 1.4rem;
      }

      .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.3s ease;
      }

      .close:hover {
        opacity: 0.7;
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 20px;
        padding: 0 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-group small {
        display: block;
        margin-top: 5px;
        color: #7f8c8d;
        font-size: 12px;
      }

      /* Button Styles */
      .modal-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        padding: 20px 25px;
        border-top: 1px solid #e9ecef;
      }

      .btn-cancel,
      .btn-create,
      .btn-save,
      .btn-copy,
      .btn-refresh,
      .btn-send,
      .btn-delete,
      .btn-confirm {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-cancel {
        background-color: #6c757d;
        color: white;
      }

      .btn-cancel:hover {
        background-color: #5a6268;
      }

      .btn-create,
      .btn-save,
      .btn-confirm {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-create:hover,
      .btn-save:hover,
      .btn-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-copy,
      .btn-refresh,
      .btn-send {
        background-color: #365ee2;
        color: white;
        padding: 8px 16px;
        font-size: 12px;
      }

      .btn-copy:hover,
      .btn-refresh:hover,
      .btn-send:hover {
        background-color: #274bb5;
      }

      .btn-delete {
        background-color: #dc3545;
        color: white;
        width: 100%;
      }

      .btn-delete:hover {
        background-color: #c82333;
      }

      /* Group Management Styles */
      .group-management-content {
        padding: 0;
      }

      .group-info-section,
      .invitation-section,
      .members-section,
      .danger-zone {
        padding: 20px 25px;
        border-bottom: 1px solid #e9ecef;
      }

      .group-info-section:last-child,
      .invitation-section:last-child,
      .members-section:last-child,
      .danger-zone:last-child {
        border-bottom: none;
      }

      .group-info-section h4,
      .invitation-section h4,
      .members-section h4,
      .danger-zone h4 {
        margin: 0 0 15px 0;
        color: #2c3e50;
        font-size: 1.1rem;
      }

      /* Invitation Code Styles */
      .code-display {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 10px 0;
      }

      #invitationCode {
        flex: 1;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 6px;
        font-family: monospace;
        font-weight: bold;
        color: #365ee2;
        border: 1px dashed #365ee2;
      }

      .email-input-group {
        display: flex;
        gap: 10px;
        margin: 10px 0;
      }

      .email-input-group input {
        flex: 1;
      }

      /* Members List Styles */
      .members-list {
        max-height: 200px;
        overflow-y: auto;
      }

      .member-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 8px;
      }

      .member-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .member-role {
        background: #365ee2;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
      }

      .member-role.owner {
        background: #28a745;
      }

      .member-role.admin {
        background: #ffc107;
        color: #000;
      }

      .member-actions {
        display: flex;
        gap: 5px;
      }

      .member-actions button {
        padding: 4px 8px;
        font-size: 11px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .btn-remove {
        background: #dc3545;
        color: white;
      }

      .btn-promote {
        background: #17a2b8;
        color: white;
      }

      /* Danger Zone */
      .danger-zone {
        background: #fff5f5;
        border: 1px solid #fed7d7;
        border-radius: 8px;
        margin: 20px 25px;
      }

      .danger-zone h4 {
        color: #c53030;
      }

      .danger-zone small {
        color: #e53e3e;
        display: block;
        margin-top: 10px;
      }
      /* Toast Notifications */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        animation: slideInRight 0.3s ease;
      }

      .toast-success {
        background: #28a745;
      }

      .toast-error {
        background: #dc3545;
      }

      .toast-info {
        background: #17a2b8;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .section {
          padding: 20px;
          flex-direction: column;
          gap: 20px;
          height: auto;
        }

        .task-section .cards {
          flex-direction: column;
          align-items: center;
        }

        .tasks-display {
          width: 100%;
          max-width: 400px;
        }

        .group-item {
          margin: 10px;
        }

        .modal-content {
          margin: 10% auto;
          width: 95%;
        }

        .group-actions {
          flex-direction: column;
          align-items: center;
        }

        .group-actions button {
          width: 200px;
        }
      }

      /* Empty State Styles */
      .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 2px dashed #dee2e6;
        margin: 2rem 0;
      }

      .empty-icon {
        margin-bottom: 1.5rem;
      }

      .empty-state h5 {
        color: #495057;
        margin-bottom: 1rem;
        font-size: 1.5rem;
      }

      .empty-message {
        color: #6c757d;
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 2rem;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
      }

      .empty-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn-primary {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.3s ease;
      }

      .btn-primary:hover {
        background: #0056b3;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.3s ease;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      /* Groups Container */
      .groups-container {
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .groups-display {
        width: 100%;
      }

      /* Create Group Bottom */
      .create-group-bottom {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid #dee2e6;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .empty-actions {
          flex-direction: column;
          align-items: center;
        }

        .empty-actions button {
          width: 200px;
        }

        .create-group-bottom {
          flex-direction: column;
        }
      }

      /* Join Section - Remove background color */
      .join-section {
        margin-top: 20px;
        padding: 15px;
        /* Remove background color and border */
        border-radius: 8px;
      }

      .btn-join {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
      }

      .btn-join:hover {
        background: #218838;
      }

      /* Leave Section - Remove background color */
      .leave-section {
        margin-top: 20px;
        padding: 15px;
        /* Remove background color and border */
        border-radius: 8px;
        text-align: center;
      }

      .btn-leave {
        background: #dc3545;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
      }

      .btn-leave:hover {
        background: #c82333;
      }

      /* Group Details - Remove background color */
      .group-details {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .group-details p {
        margin: 8px 0;
        padding: 5px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .group-details p:last-child {
        border-bottom: none;
      }

      .group-admin-info {
        margin: 8px 0;
        padding: 5px 0;
      }

      .group-admin-info small {
        color: #666;
        font-size: 0.9em;
      }

      .member-name {
        font-weight: 500;
      }

      .member-role.admin {
        background: #ffd700;
        color: #000;
        font-weight: bold;
      }

      /* Group Management Modal Styles */
      .group-management {
        max-width: 800px;
        width: 90%;
      }

      .group-tabs {
        display: flex;
        border-bottom: 1px solid #e2e8f0;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .tab-btn {
        background: none;
        border: none;
        padding: 12px 20px;
        font-size: 0.9rem;
        font-weight: 500;
        color: #64748b;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
      }

      .tab-btn:hover {
        color: #365ee2;
        background: #f8fafc;
      }

      .tab-btn.active {
        color: #365ee2;
        border-bottom-color: #365ee2;
        background: #f8fafc;
      }

      .tab-content {
        min-height: 400px;
      }

      .tab-pane {
        display: none;
        animation: fadeIn 0.3s ease;
      }

      .tab-pane.active {
        display: block;
      }

      /* Tasks Tab Specific Styles */
      .tasks-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e2e8f0;
      }

      .tasks-header h4 {
        margin: 0;
        color: #1e293b;
        font-size: 1.2rem;
      }

      .btn-create-task {
        display: flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, #365ee2, #4f7cfe);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(54, 94, 226, 0.3);
      }

      .btn-create-task:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(54, 94, 226, 0.4);
        background: linear-gradient(135deg, #2d52c7, #4569e0);
      }

      .btn-create-task:active {
        transform: translateY(0);
      }

      .btn-create-task i {
        font-size: 0.8rem;
      }

      /* Group Tasks List Styles */
      .tasks-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 500px;
        overflow-y: auto;
        padding-right: 5px;
      }

      .tasks-list::-webkit-scrollbar {
        width: 6px;
      }

      .tasks-list::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
      }

      .tasks-list::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      .tasks-list::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      .group-task-item {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 16px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .group-task-item:hover {
        border-color: #365ee2;
        box-shadow: 0 2px 8px rgba(54, 94, 226, 0.1);
        transform: translateY(-1px);
      }

      .group-task-main {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
        gap: 15px;
      }

      .group-task-main h5 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: #1e293b;
        flex: 1;
        line-height: 1.4;
      }

      .task-status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
      }

      .task-status-badge.pending {
        background: #fef3c7;
        color: #d97706;
        border: 1px solid #fcd34d;
      }

      .task-status-badge.in-progress {
        background: #dbeafe;
        color: #365ee2;
        border: 1px solid #93c5fd;
      }

      .task-status-badge.completed {
        background: #d1fae5;
        color: #059669;
        border: 1px solid #6ee7b7;
      }

      .group-task-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        font-size: 0.8rem;
        color: #64748b;
      }

      .group-task-meta span {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        background: #f8fafc;
        border-radius: 6px;
      }

      .priority-high {
        color: #dc2626;
        font-weight: 600;
      }

      .priority-medium {
        color: #d97706;
        font-weight: 600;
      }

      .priority-low {
        color: #059669;
        font-weight: 600;
      }

      /* Top Action Buttons in Group Management */
      .group-management-content {
        padding: 0 10px;
      }

      .group-info-section,
      .invitation-section,
      .members-section,
      .danger-zone,
      .leave-section {
        margin-bottom: 25px;
        padding: 20px;
        background: #fff;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
      }

      .group-info-section h4,
      .invitation-section h4,
      .members-section h4,
      .danger-zone h4 {
        margin: 0 0 15px 0;
        color: #1e293b;
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .group-info-section h4::before {
        content: "üìã";
      }

      .invitation-section h4::before {
        content: "üë•";
      }

      .members-section h4::before {
        content: "üë§";
      }

      .danger-zone h4::before {
        content: "‚ö†Ô∏è";
      }

      /* Invitation Code Section */
      .invitation-code {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }

      .invitation-code label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
      }

      .code-display {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }

      #invitationCode {
        font-family: "Courier New", monospace;
        font-size: 1.2rem;
        font-weight: 700;
        color: #365ee2;
        background: white;
        padding: 8px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        flex: 1;
        min-width: 120px;
      }

      .btn-copy,
      .btn-refresh {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-copy {
        background: #10b981;
        color: white;
      }

      .btn-copy:hover {
        background: #059669;
        transform: translateY(-1px);
      }

      .btn-refresh {
        background: #f59e0b;
        color: white;
      }

      .btn-refresh:hover {
        background: #d97706;
        transform: translateY(-1px);
      }

      /* Danger Zone Styles */
      .danger-zone {
        border-color: #fecaca;
        background: #fef2f2;
      }

      .danger-zone h4 {
        color: #dc2626;
      }

      .btn-delete {
        background: #dc2626;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin-bottom: 8px;
      }

      .btn-delete:hover {
        background: #b91c1c;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
      }

      /* Leave Section */
      .leave-section {
        text-align: center;
        background: #fff7ed;
        border-color: #fed7aa;
      }

      .btn-leave {
        background: #f97316;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 8px;
      }

      .btn-leave:hover {
        background: #ea580c;
        transform: translateY(-2px);
      }

      /* Modal Actions */
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
      }

      .btn-cancel {
        background: #64748b;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-cancel:hover {
        background: #475569;
      }

      .btn-create {
        background: #365ee2;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-create:hover {
        background: #2d52c7;
        transform: translateY(-1px);
      }

      /* Responsive Design for Group Management */
      @media (max-width: 768px) {
        .group-management {
          width: 95%;
          margin: 10px;
        }

        .group-tabs {
          flex-direction: column;
        }

        .tab-btn {
          text-align: left;
          border-bottom: 1px solid #e2e8f0;
          border-left: 3px solid transparent;
        }

        .tab-btn.active {
          border-left-color: #365ee2;
          border-bottom-color: #e2e8f0;
        }

        .tasks-header {
          flex-direction: column;
          gap: 15px;
          align-items: stretch;
        }

        .btn-create-task {
          justify-content: center;
        }

        .group-task-main {
          flex-direction: column;
          gap: 10px;
        }

        .group-task-meta {
          flex-direction: column;
          gap: 8px;
        }

        .code-display {
          flex-direction: column;
          align-items: stretch;
        }

        #invitationCode {
          text-align: center;
        }

        .modal-actions {
          flex-direction: column;
        }
      }

      /* Animation for tab switching */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Empty state in tasks tab */
      .tasks-list .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #64748b;
        background: #f8fafc;
        border: 2px dashed #e2e8f0;
        border-radius: 8px;
      }

      .tasks-list .empty-state p {
        margin: 0;
        font-style: italic;
      }

      .assign-help {
        display: block;
        margin-top: 5px;
        color: #6c757d;
        font-size: 12px;
        font-style: italic;
      }

      .task-assignee.unassigned {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px dashed #dee2e6;
      }

      .task-assignee.unassigned i {
        color: #adb5bd;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-header">
      <div class="user-info">
        <h1>TaskFlow Dashboard</h1>
        <p>Welcome back, <span id="userFullname">User</span>!</p>
      </div>
      <button class="logout-btn" onclick="logout()">
        Logout
        <span><i class="fa-solid fa-arrow-right-from-bracket"></i></span>
      </button>
    </div>

    <div class="section">
      <!-- Additional dashboard content can go here -->
      <div class="display">
        <div class="icon-text">
          <span><i class="fa-solid fa-clipboard-check"></i></span>
          <p>My Tasks</p>
        </div>

        <div class="icon-text" id="group">
          <span><i class="fa-solid fa-users"></i></span>
          <p>Groups</p>
        </div>
      </div>
    </div>

    <div class="task-section">
      <!-- Task section content can go here -->
      <h1>My Tasks</h1>
      <p>Manage and track your tasks</p>

      <div class="cards">
        <div class="tasks-display">
          <!-- Individual tasks will be displayed here -->
          <h5>
            <span
              ><i
                style="color: rgba(223, 203, 113, 0.848)"
                class="fa-solid fa-bell"
              ></i
            ></span>
            To Do
          </h5>

          <p class="empty">No tasks to do</p>
        </div>

        <div class="tasks-display">
          <!-- Individual tasks will be displayed here -->
          <h5>
            <span
              ><i
                style="color: rgb(232, 144, 37)"
                class="fa-regular fa-clock"
              ></i
            ></span>
            In Progress
          </h5>

          <p class="empty">No tasks in progress</p>
        </div>

        <div class="tasks-display">
          <!-- Individual tasks will be displayed here -->
          <h5>
            <span
              ><i
                style="color: greenyellow"
                class="fa-regular fa-circle-check"
              ></i
            ></span>
            Completed
          </h5>

          <p class="empty">No completed tasks</p>
        </div>
      </div>
    </div>

    <!-- Groups Section -->
    <div class="group-section" style="display: none">
      <div class="section-header" style="margin-bottom: 23px">
        <h2>My Groups</h2>
      </div>

      <div class="groups-container">
        <!-- This is where groups will be displayed -->
        <div id="groupsDisplay" class="groups-display">
          <!-- Groups will be rendered here by JavaScript -->
        </div>
      </div>

      <!-- Bottom Create Group Button for mobile -->
      <div class="create-group-bottom">
        <button id="createGroupBottomBtn" class="btn-primary">
          <i class="fa-solid fa-plus"></i>
          Create New Group
        </button>
        <button
          style="background-color: rgb(75, 219, 75); color: white"
          id="joinGroupBtn"
          class="btn-secondary"
        >
          <i class="fa-solid fa-arrow-right-to-bracket"></i>
          Join a Group
        </button>
      </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Create New Group</h3>
          <span class="close">&times;</span>
        </div>
        <form id="createGroupForm">
          <div class="form-group">
            <label for="groupName">Group Name</label>
            <input
              type="text"
              id="groupName"
              name="groupName"
              required
              maxlength="50"
            />
            <small
              >Group name must be 3-50 characters, no special symbols except
              spaces and hyphens</small
            >
          </div>
          <div class="form-group">
            <label for="groupDescription">Description</label>
            <textarea
              id="groupDescription"
              name="groupDescription"
              rows="3"
              maxlength="200"
            ></textarea>
            <small>Optional: Describe your group (max 200 characters)</small>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-cancel">Cancel</button>
            <button type="submit" class="btn-create">Create Group</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Group Management Modal -->
    <div id="groupManagementModal" class="modal">
      <div class="modal-content group-management">
        <div class="modal-header">
          <h3 id="groupManagementTitle">Manage Group</h3>
          <span class="close">&times;</span>
        </div>
        <div class="group-management-content">
          <!-- Group Info Section -->
          <div class="group-info-section">
            <h4>Group Information</h4>
            <form id="editGroupForm">
              <div class="form-group">
                <label for="editGroupName">Group Name</label>
                <input
                  type="text"
                  id="editGroupName"
                  name="groupName"
                  required
                  maxlength="50"
                />
              </div>
              <div class="form-group">
                <label for="editGroupDescription">Description</label>
                <textarea
                  id="editGroupDescription"
                  name="groupDescription"
                  rows="3"
                  maxlength="200"
                ></textarea>
              </div>
              <button type="submit" class="btn-save">Save Changes</button>
            </form>
          </div>

          <!-- Invitation Section -->
          <div class="invitation-section">
            <h4>Invite Members</h4>
            <div class="invitation-code">
              <label>Invitation Code:</label>
              <div class="code-display">
                <span id="invitationCode">Loading...</span>
                <button id="copyCode" class="btn-copy">Copy</button>
                <button id="refreshCode" class="btn-refresh">Refresh</button>
              </div>
              <small
                >Share this code with people you want to invite to this
                group</small
              >
            </div>

            <div class="invite-by-email">
              <label>Or invite by email:</label>
              <div class="email-input-group">
                <input
                  type="email"
                  id="inviteEmail"
                  placeholder="Enter email address"
                />
                <button id="sendInvite" class="btn-send">Send Invite</button>
              </div>
            </div>
          </div>

          <!-- Members Section -->
          <div class="members-section">
            <h4>Group Members</h4>
            <div id="membersList" class="members-list">
              <!-- Members will be dynamically added here -->
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="danger-zone">
            <h4>Danger Zone</h4>
            <button id="deleteGroup" class="btn-delete">Delete Group</button>
            <small
              >This action cannot be undone. All group data will be permanently
              deleted.</small
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
      <div class="modal-content confirmation">
        <h3 id="confirmationTitle">Confirm Action</h3>
        <p id="confirmationMessage">Are you sure you want to proceed?</p>
        <div class="modal-actions">
          <button id="confirmCancel" class="btn-cancel">Cancel</button>
          <button id="confirmAction" class="btn-confirm">Confirm</button>
        </div>
      </div>
    </div>

    <!-- Add this to your HTML for the create task modal -->
    <div id="createTaskModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Create New Task</h3>
          <span class="close">&times;</span>
        </div>
        <form id="createTaskForm">
          <div class="form-group">
            <label for="taskTitle">Task Title *</label>
            <input
              type="text"
              id="taskTitle"
              name="title"
              required
              placeholder="Enter task title"
            />
          </div>

          <div class="form-group">
            <label for="taskDescription">Description</label>
            <textarea
              id="taskDescription"
              name="description"
              rows="3"
              placeholder="Enter task description"
            ></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="taskPriority">Priority</label>
              <select id="taskPriority" name="priority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>

            <div class="form-group">
              <label for="taskDueDate">Due Date</label>
              <input type="date" id="taskDueDate" name="dueDate" />
            </div>
          </div>

          <div class="form-group">
            <label for="taskAssignTo">Assign To</label>
            <select id="taskAssignTo" name="assignedTo">
              <option value="">Unassigned</option>
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-cancel">Cancel</button>
            <button type="submit" class="btn-create">Create Task</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      window.onload = function () {
        console.log("=== DASHBOARD LOADED ===");

        const token = localStorage.getItem("token");
        const userStr = localStorage.getItem("user");

        if (!token || !userStr) {
          window.location.href = "login.html";
          return;
        }

        try {
          const user = JSON.parse(userStr);
          const nameElement = document.getElementById("userFullname");

          if (nameElement) {
            // Try multiple property names
            let userName = "User";

            if (user.name) userName = user.name;
            else if (user.fullname) userName = user.fullname;
            else if (user.username) userName = user.username;
            else if (user.email) userName = user.email.split("@")[0];
            // Use email prefix as fallback
            else userName = "User";

            console.log("Setting name to:", userName);
            nameElement.textContent = userName;

            // Force update with timeout as fallback
            setTimeout(() => {
              if (nameElement.textContent === "User") {
                nameElement.textContent = userName;
                console.log("Forced name update:", userName);
              }
            }, 100);
          }
        } catch (error) {
          console.error("Error:", error);
          window.location.href = "login.html";
        }
      };
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "login.html";
      }

      // Add this to your script
      document.addEventListener("DOMContentLoaded", function () {
        const taskIcon = document.querySelector(".icon-text:first-child");
        const groupIcon = document.getElementById("group");
        const taskSection = document.querySelector(".task-section");
        const groupSection = document.querySelector(".group-section");
        const newTaskBtn = document.querySelectorAll(".add button");

        // Initially show task section and hide group section
        if (taskSection) taskSection.style.display = "block";
        if (groupSection) groupSection.style.display = "none";

        // Add active state to task icon initially
        taskIcon.classList.add("active");

        // Task icon click event
        taskIcon.addEventListener("click", function () {
          // Show task section, hide group section
          if (taskSection) taskSection.style.display = "block";
          if (groupSection) groupSection.style.display = "none";

          // Update active states
          taskIcon.classList.add("active");
          groupIcon.classList.remove("active");

          // Update button text
          if (newTaskBtn) {
            newTaskBtn.innerHTML =
              '<span><i class="fa-solid fa-plus"></i></span>New Task';
          }
        });

        // Group icon click event
        groupIcon.addEventListener("click", function () {
          // Show group section, hide task section
          if (groupSection) groupSection.style.display = "block";
          if (taskSection) taskSection.style.display = "none";

          // Update active states
          groupIcon.classList.add("active");
          taskIcon.classList.remove("active");
        });
      });
      // Enhanced Group Management System
      class GroupManager {
        constructor() {
          this.currentGroup = null;
          this.groups =
            JSON.parse(localStorage.getItem("taskflow_groups")) || [];
          this.tasks = JSON.parse(localStorage.getItem("taskflow_tasks")) || [];
          this.init();
        }

        init() {
          this.bindEvents();
          this.renderGroups();
          this.renderTasks();
          this.setupTabSwitching();
        }

        setupTabSwitching() {
          const taskTab = document.getElementById("taskTab");
          const groupTab = document.getElementById("groupTab");
          const taskSection = document.querySelector(".task-section");
          const groupSection = document.querySelector(".group-section");
          const createGroupTopBtn =
            document.getElementById("createGroupTopBtn");

          if (taskTab && groupTab && taskSection && groupSection) {
            taskTab.addEventListener("click", () => {
              taskSection.style.display = "block";
              groupSection.style.display = "none";
              taskTab.classList.add("active");
              groupTab.classList.remove("active");
              if (createGroupTopBtn) createGroupTopBtn.style.display = "none";
            });

            groupTab.addEventListener("click", () => {
              groupSection.style.display = "block";
              taskSection.style.display = "none";
              groupTab.classList.add("active");
              taskTab.classList.remove("active");
              if (createGroupTopBtn) createGroupTopBtn.style.display = "flex";
            });

            // Initialize with tasks view
            taskSection.style.display = "block";
            groupSection.style.display = "none";
            if (createGroupTopBtn) createGroupTopBtn.style.display = "none";
          }
        }

        bindEvents() {
          // Event delegation for close buttons
          document.addEventListener("click", (e) => {
            // Close modal when clicking X
            if (e.target.classList.contains("close")) {
              const modal = e.target.closest(".modal");
              if (modal) {
                this.closeModal(modal);
              }
            }

            // Close modal when clicking cancel button
            if (e.target.classList.contains("btn-cancel")) {
              const modal = e.target.closest(".modal");
              if (modal) {
                this.closeModal(modal);
              }
            }

            // Close modal when clicking outside
            if (e.target.classList.contains("modal")) {
              this.closeModal(e.target);
            }
          });

          // Create Group Buttons - TOP AND BOTTOM
          const createGroupTopBtn =
            document.getElementById("createGroupTopBtn");
          const createGroupBottomBtn = document.getElementById(
            "createGroupBottomBtn"
          );
          const joinGroupBtn = document.getElementById("joinGroupBtn");

          if (createGroupTopBtn) {
            createGroupTopBtn.addEventListener("click", () =>
              this.openCreateGroupModal()
            );
          }

          if (createGroupBottomBtn) {
            createGroupBottomBtn.addEventListener("click", () =>
              this.openCreateGroupModal()
            );
          }

          if (joinGroupBtn) {
            joinGroupBtn.addEventListener("click", () =>
              this.openJoinGroupModal()
            );
          }

          // Form Submissions
          document.addEventListener("submit", (e) => {
            if (e.target.id === "createGroupForm") {
              e.preventDefault();
              this.handleCreateGroup(e);
            }

            if (e.target.id === "editGroupForm") {
              e.preventDefault();
              this.handleEditGroup(e);
            }

            if (e.target.id === "createTaskForm") {
              e.preventDefault();
              this.handleCreateTask(e);
            }
          });

          // Button click handlers
          document.addEventListener("click", (e) => {
            if (e.target.id === "copyCode") {
              this.copyInvitationCode();
            }

            if (e.target.id === "refreshCode") {
              this.refreshInvitationCode();
            }

            if (e.target.id === "deleteGroup") {
              this.confirmDeleteGroup();
            }

            if (e.target.id === "joinGroupConfirmBtn") {
              this.joinGroupWithCode();
            }
          });
        }

        // GROUP MANAGEMENT METHODS
        openCreateGroupModal() {
          console.log("Opening create group modal");

          const modal = document.getElementById("createGroupModal");
          if (!modal) {
            console.error("Create group modal not found in HTML");
            return;
          }

          const form = document.getElementById("createGroupForm");
          if (form) form.reset();

          this.openModal(modal);
        }

        handleCreateGroup(e) {
          e.preventDefault();

          const nameInput = document.getElementById("groupName");
          const descriptionInput = document.getElementById("groupDescription");

          if (!nameInput) {
            console.error("Group name input not found");
            return;
          }

          const name = nameInput.value.trim();
          const description = descriptionInput
            ? descriptionInput.value.trim()
            : "";

          const validation = this.validateGroupName(name);
          if (!validation.isValid) {
            alert(`Group name violation: ${validation.message}`);
            return;
          }

          const currentUser = this.getCurrentUser();

          const newGroup = {
            id: this.generateId(),
            name: name,
            description: description,
            created: new Date().toISOString(),
            members: [
              {
                id: this.generateId(),
                name: currentUser.name,
                email: currentUser.email,
                role: "admin",
                joined: new Date().toISOString(),
              },
            ],
            invitationCode: this.generateInvitationCode(),
          };

          this.groups.push(newGroup);
          this.saveGroups();
          this.renderGroups();
          this.closeModal(document.getElementById("createGroupModal"));
          this.showToast(`Group "${name}" created successfully!`, "success");
        }

        // JOIN GROUP FUNCTIONALITY
        openJoinGroupModal() {
          console.log("Opening join group modal");

          let modal = document.getElementById("joinGroupModal");
          if (!modal) {
            modal = document.createElement("div");
            modal.id = "joinGroupModal";
            modal.className = "modal";
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Join a Group</h3>
                        <span class="close">&times;</span>
                    </div>
                    <div class="form-group">
                        <label for="invitationCodeInput">Enter Invitation Code</label>
                        <input type="text" id="invitationCodeInput" placeholder="e.g., A1B2C3D4" maxlength="8" style="text-transform: uppercase">
                        <small>Get the invitation code from the group owner or admin</small>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-cancel">Cancel</button>
                        <button type="button" class="btn-create" id="joinGroupConfirmBtn">Join Group</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
          }

          const codeInput = document.getElementById("invitationCodeInput");
          if (codeInput) codeInput.value = "";

          this.openModal(modal);
        }

        joinGroupWithCode() {
          const codeInput = document.getElementById("invitationCodeInput");
          if (!codeInput) return;

          const code = codeInput.value.trim().toUpperCase();

          if (!code) {
            alert("Please enter an invitation code");
            return;
          }

          if (code.length !== 8) {
            alert("Invitation code must be 8 characters long");
            return;
          }

          const group = this.groups.find((g) => g.invitationCode === code);

          if (!group) {
            alert(
              "Invalid invitation code. Please check the code and try again."
            );
            return;
          }

          const currentUser = this.getCurrentUser();
          const isAlreadyMember = group.members.some(
            (member) => member.email === currentUser.email
          );

          if (isAlreadyMember) {
            alert("You are already a member of this group!");
            return;
          }

          // Add user to group as a regular member
          group.members.push({
            id: this.generateId(),
            name: currentUser.name,
            email: currentUser.email,
            role: "member",
            joined: new Date().toISOString(),
          });

          this.saveGroups();
          this.renderGroups();
          this.closeModal(document.getElementById("joinGroupModal"));
          this.showToast(`Successfully joined "${group.name}"!`, "success");
        }

        openGroupManagement(group) {
          this.currentGroup = group;
          const currentUser = this.getCurrentUser();
          const userRole = this.getUserRoleInGroup(group, currentUser.email);
          const isMember = userRole !== "non-member";
          const isAdmin = userRole === "admin";
          const adminUser = group.members.find(
            (member) => member.role === "admin"
          );
          const adminName = adminUser ? adminUser.name : "Unknown Admin";

          let modal = document.getElementById("groupManagementModal");
          if (!modal) {
            modal = document.createElement("div");
            modal.id = "groupManagementModal";
            modal.className = "modal";
            document.body.appendChild(modal);
          }

          modal.innerHTML = `
            <div class="modal-content group-management">
                <div class="modal-header">
                    <h3>${isMember ? "Manage:" : "View:"} ${group.name}</h3>
                    <span class="close">&times;</span>
                </div>
                
                <!-- Tabs for Group Management -->
                <div class="group-tabs">
                    <button class="tab-btn active" data-tab="info">Group Info</button>
                    ${
                      isMember
                        ? `
                        <button class="tab-btn" data-tab="tasks">Group Tasks</button>
                        <button class="tab-btn" data-tab="members">Members</button>
                        ${
                          isAdmin
                            ? '<button class="tab-btn" data-tab="settings">Settings</button>'
                            : ""
                        }
                    `
                        : ""
                    }
                </div>

                <div class="tab-content">
                    <!-- Info Tab -->
                    <div class="tab-pane active" id="info-tab">
                        <div class="group-info-section">
                            <h4>Group Information</h4>
                            <div class="group-details">
                                <p><strong>Name:</strong> ${group.name}</p>
                                ${
                                  group.description
                                    ? `<p><strong>Description:</strong> ${group.description}</p>`
                                    : ""
                                }
                                <p><strong>Admin:</strong> ${adminName}</p>
                                <p><strong>Members:</strong> ${
                                  group.members.length
                                }</p>
                                <p><strong>Created:</strong> ${new Date(
                                  group.created
                                ).toLocaleDateString()}</p>
                            </div>
                        </div>

                        ${
                          isMember
                            ? `
                        <div class="invitation-section">
                            <h4>Invite Members</h4>
                            <div class="invitation-code">
                                <label>Invitation Code:</label>
                                <div class="code-display">
                                    <span id="invitationCode">${
                                      group.invitationCode
                                    }</span>
                                    <button id="copyCode" class="btn-copy">Copy</button>
                                    ${
                                      isAdmin
                                        ? '<button id="refreshCode" class="btn-refresh">Refresh</button>'
                                        : ""
                                    }
                                </div>
                                <small>Share this code with people you want to invite to this group</small>
                            </div>
                        </div>
                        `
                            : ""
                        }
                    </div>

                    <!-- Tasks Tab (Only for members) -->
                    ${
                      isMember
                        ? `
                    <div class="tab-pane" id="tasks-tab">
                        <div class="group-tasks-section">
                            <div class="tasks-header">
                                <h4>Group Tasks</h4>
                                ${
                                  isAdmin
                                    ? `
                                    <button class="btn-create-task" onclick="groupManager.openCreateTaskModal()">
                                        <i class="fa-solid fa-plus"></i> Create Task
                                    </button>
                                `
                                    : ""
                                }
                            </div>
                            
                            <div id="groupTasksList" class="tasks-list">
                                ${this.renderGroupTasksList(group.id)}
                            </div>
                        </div>
                    </div>
                    `
                        : ""
                    }

                    <!-- Members Tab -->
                    ${
                      isMember
                        ? `
                    <div class="tab-pane" id="members-tab">
                        <div class="members-section">
                            <h4>Group Members (${group.members.length})</h4>
                            <div class="members-list">
                                ${this.renderMembersList(group, userRole)}
                            </div>
                        </div>
                    </div>
                    `
                        : ""
                    }

                    <!-- Settings Tab (Admin only) -->
                    ${
                      isAdmin
                        ? `
                    <div class="tab-pane" id="settings-tab">
                        <div class="danger-zone">
                            <h4>Danger Zone</h4>
                            <button id="deleteGroup" class="btn-delete">Delete Group</button>
                            <small>This action cannot be undone. All group data will be permanently deleted.</small>
                        </div>
                    </div>
                    `
                        : ""
                    }
                </div>

                ${
                  isMember && !isAdmin
                    ? `
                <div class="leave-section">
                    <button class="btn-leave" onclick="groupManager.leaveGroup()">Leave Group</button>
                    <small>You will be removed from this group and lose access to its content.</small>
                </div>
                `
                    : ""
                }
            </div>
        `;

          this.openModal(modal);
          this.initGroupTabs();
        }

        initGroupTabs() {
          const tabBtns = document.querySelectorAll(".tab-btn");
          const tabPanes = document.querySelectorAll(".tab-pane");

          tabBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
              // Remove active class from all buttons and panes
              tabBtns.forEach((b) => b.classList.remove("active"));
              tabPanes.forEach((p) => p.classList.remove("active"));

              // Add active class to clicked button
              btn.classList.add("active");

              // Show corresponding pane
              const tabName = btn.getAttribute("data-tab");
              const tabPane = document.getElementById(`${tabName}-tab`);
              if (tabPane) {
                tabPane.classList.add("active");
              }
            });
          });
        }

        // Check user role in group
        getUserRoleInGroup(group, userEmail) {
          const member = group.members.find((m) => m.email === userEmail);
          return member ? member.role : "non-member";
        }

        renderMembersList(group, currentUserRole) {
          const currentUser = this.getCurrentUser();
          const isMember = currentUserRole !== "non-member";

          return group.members
            .map(
              (member) => `
                    <div class="member-item">
                        <div class="member-info">
                            <span>${member.name} ${
                member.email === currentUser.email ? "(You)" : ""
              }</span>
                            <span class="member-role ${
                              member.role
                            }">${member.role.toUpperCase()}</span>
                        </div>
                        <div class="member-actions">
                            ${
                              currentUserRole === "admin" &&
                              member.role !== "admin"
                                ? `
                                <button class="btn-promote" onclick="groupManager.promoteMember('${member.id}')">Promote to Admin</button>
                                <button class="btn-remove" onclick="groupManager.removeMember('${member.id}')">Remove</button>
                            `
                                : ""
                            }
                            ${
                              isMember &&
                              member.email === currentUser.email &&
                              member.role !== "admin"
                                ? `
                                <button class="btn-leave" onclick="groupManager.leaveGroup()">Leave Group</button>
                            `
                                : ""
                            }
                        </div>
                    </div>
                `
            )
            .join("");
        }

        promoteMember(memberId) {
          const member = this.currentGroup.members.find(
            (m) => m.id === memberId
          );
          if (member) {
            member.role = "admin";
            this.saveGroups();
            this.openGroupManagement(this.currentGroup);
            this.showToast(`Promoted ${member.name} to admin`, "success");
          }
        }

        removeMember(memberId) {
          if (this.currentGroup.members.length <= 1) {
            alert("Cannot remove the only member. Delete the group instead.");
            return;
          }

          const member = this.currentGroup.members.find(
            (m) => m.id === memberId
          );
          if (member) {
            // REMOVE MEMBER'S TASKS BEFORE REMOVING THEM
            this.removeUserTasksFromGroup(memberId, this.currentGroup.id);

            this.currentGroup.members = this.currentGroup.members.filter(
              (m) => m.id !== memberId
            );
            this.saveGroups();
            this.saveTasks(); // Save after removing tasks
            this.openGroupManagement(this.currentGroup);
            this.renderTasks(); // Re-render tasks
            this.showToast(
              `Removed ${member.name} from group and their assigned tasks`,
              "success"
            );
          }
        }

        leaveGroup() {
          if (!this.currentGroup) {
            this.showToast("No group selected", "error");
            return;
          }

          const currentUser = this.getCurrentUser();
          const groupIndex = this.groups.findIndex(
            (g) => g.id === this.currentGroup.id
          );
          if (groupIndex === -1) {
            this.showToast("Group not found", "error");
            return;
          }

          const initialLength = this.currentGroup.members.length;
          this.currentGroup.members = this.currentGroup.members.filter(
            (m) => m.email !== currentUser.email
          );

          if (initialLength === this.currentGroup.members.length) {
            this.showToast("You are not a member of this group", "error");
            return;
          }

          // REMOVE USER'S TASKS FROM THIS GROUP
          this.removeUserTasksFromGroup(currentUser.id, this.currentGroup.id);

          this.groups[groupIndex] = this.currentGroup;
          this.saveGroups();
          this.saveTasks(); // Save after removing tasks
          this.renderGroups();
          this.renderTasks(); // Re-render tasks after removal
          this.closeModal(document.getElementById("groupManagementModal"));
          this.showToast(`You left "${this.currentGroup.name}"`, "info");
        }

        // NEW: Remove user's tasks when they leave a group
        removeUserTasksFromGroup(userId, groupId) {
          const initialTaskCount = this.tasks.length;

          // Remove tasks where user is assigned AND task belongs to this group
          this.tasks = this.tasks.filter((task) => {
            if (task.groupId !== groupId) return true;

            if (
              !task.assignedTo ||
              task.assignedTo === "Unassigned" ||
              task.assignedTo === null
            )
              return true;

            if (task.assignedTo !== userId) return true;

            if (task.createdBy === userId && task.assignedTo !== userId)
              return true;

            return false;
          });

          const removedCount = initialTaskCount - this.tasks.length;
          if (removedCount > 0) {
            console.log(
              `Removed ${removedCount} tasks for user ${userId} from group ${groupId}`
            );
          }
        }

        deleteCurrentGroup() {
          const groupId = this.currentGroup.id;
          const groupName = this.currentGroup.name;

          // REMOVE ALL TASKS BELONGING TO THIS GROUP
          const initialTaskCount = this.tasks.length;
          this.tasks = this.tasks.filter((task) => task.groupId !== groupId);
          const removedTasksCount = initialTaskCount - this.tasks.length;

          this.groups = this.groups.filter((g) => g.id !== groupId);
          this.saveGroups();
          this.saveTasks(); // Save after removing tasks
          this.renderGroups();
          this.renderTasks(); // Re-render tasks

          this.closeModal(document.getElementById("groupManagementModal"));

          let message = `Group "${groupName}" deleted successfully`;
          if (removedTasksCount > 0) {
            message += ` (${removedTasksCount} tasks removed)`;
          }

          this.showToast(message, "success");
          this.currentGroup = null;
        }

        // TASK MANAGEMENT METHODS
        openCreateTaskModal() {
          if (!this.currentGroup) {
            this.showToast("Please select a group first", "error");
            return;
          }

          let modal = document.getElementById("createTaskModal");
          if (!modal) {
            modal = document.createElement("div");
            modal.id = "createTaskModal";
            modal.className = "modal";
            document.body.appendChild(modal);
          }

          const currentUser = this.getCurrentUser();
          const groupMembers = this.currentGroup.members;

          modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create New Task in ${this.currentGroup.name}</h3>
                    <span class="close">&times;</span>
                </div>
                <form id="createTaskForm">
                    <div class="form-group">
                        <label for="taskTitle">Task Title *</label>
                        <input type="text" id="taskTitle" name="title" required maxlength="100" placeholder="Enter task title">
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDescription">Description</label>
                        <textarea id="taskDescription" name="description" rows="3" maxlength="500" placeholder="Enter task description"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskPriority">Priority</label>
                            <select id="taskPriority" name="priority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="taskDueDate">Due Date</label>
                            <input type="date" id="taskDueDate" name="dueDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskAssignTo">Assign To</label>
                        <select id="taskAssignTo" name="assignedTo">
                            <option value="">Unassigned</option>
                            ${groupMembers
                              .map(
                                (member) => `
                                <option value="${member.id}">${member.name} ${
                                  member.role === "admin" ? "üëë" : ""
                                }</option>
                            `
                              )
                              .join("")}
                        </select>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-cancel">Cancel</button>
                        <button type="submit" class="btn-create">Create Task</button>
                    </div>
                </form>
            </div>
        `;

          this.openModal(modal);

          // Set minimum date to today
          const dueDateInput = document.getElementById("taskDueDate");
          if (dueDateInput) {
            const today = new Date().toISOString().split("T")[0];
            dueDateInput.min = today;
          }
        }

        handleCreateTask(e) {
          e.preventDefault();

          const formData = new FormData(e.target);
          const title = formData.get("title");
          const description = formData.get("description");
          const priority = formData.get("priority");
          const dueDate = formData.get("dueDate");
          const assignedTo = formData.get("assignedTo");

          if (!title.trim()) {
            this.showToast("Task title is required", "error");
            return;
          }

          const currentUser = this.getCurrentUser();
          const isUnassigned = !assignedTo || assignedTo.trim() === "";

          // Find assigned member if task is assigned
          const assignedMember = isUnassigned
            ? null
            : this.currentGroup.members.find((m) => m.id === assignedTo);

          const newTask = {
            id: this.generateId(),
            title: title.trim(),
            description: description?.trim() || "",
            priority: priority || "medium",
            status: "pending",
            dueDate: dueDate || null,
            createdBy: currentUser.id,
            createdByName: currentUser.name,
            assignedTo: isUnassigned ? null : assignedTo, // Store as null for unassigned
            assignedToName: isUnassigned
              ? "Unassigned"
              : assignedMember
              ? assignedMember.name
              : "Unassigned",
            groupId: this.currentGroup.id,
            groupName: this.currentGroup.name,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            isUnassigned: isUnassigned, // Add flag for easy checking
          };

          this.tasks.push(newTask);
          this.saveTasks();
          this.renderTasks();
          this.closeModal(document.getElementById("createTaskModal"));
          this.showToast("Task created successfully!", "success");
        }

        // FIXED: Now properly handles task visibility
        getTasksByStatus(status) {
          const currentUser = this.getCurrentUser();
          const userId = currentUser.id;

          return this.tasks.filter((task) => {
            // 1. Check status matches
            if (task.status !== status) return false;

            // 2. Find the group this task belongs to
            const taskGroup = this.groups.find((g) => g.id === task.groupId);
            if (!taskGroup) return false;

            // 3. Check if user is a member of this group
            const userRole = this.getUserRoleInGroup(
              taskGroup,
              currentUser.email
            );
            const isMember = userRole !== "non-member";
            const isAdmin = userRole === "admin";

            if (!isMember) return false;

            // 4. Check if task is assigned or unassigned
            const isUnassigned =
              !task.assignedTo ||
              task.assignedTo === "Unassigned" ||
              task.assignedTo === null;
            const isAssignedToMe = task.assignedTo === userId;
            const isCreatedByMe = task.createdBy === userId;

            // VISIBILITY RULES:
            // 1. Admins can see ALL tasks in their groups
            if (isAdmin) return true;

            // 2. Unassigned tasks ‚Üí Visible to ALL group members
            if (isUnassigned) return true;

            // 3. Assigned tasks ‚Üí Only visible to assigned user & creator
            return isAssignedToMe || isCreatedByMe;
          });
        }

        // IMPROVED: Better edit functionality (no delete/recreate)
        editTask(taskId) {
          const task = this.tasks.find((t) => t.id === taskId);
          if (!task) return;

          // Set the current group to the task's group
          this.currentGroup = this.groups.find((g) => g.id === task.groupId);
          if (!this.currentGroup) {
            this.showToast("Task group not found", "error");
            return;
          }

          // Open edit modal with task data
          this.editingTaskId = taskId;
          this.showTaskModal("Edit Task", this.currentGroup.name, task);
        }

        // NEW: Unified task modal handler
        showTaskModal(title, groupName, task = null) {
          const isEditMode = !!task;
          let modal = document.getElementById("taskModal");

          if (!modal) {
            modal = document.createElement("div");
            modal.id = "taskModal";
            modal.className = "modal";
            document.body.appendChild(modal);
          }

          const currentUser = this.getCurrentUser();
          const groupMembers = this.currentGroup.members;

          modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>${title} in ${groupName}</h3>
                <span class="close">&times;</span>
            </div>
            <form id="${isEditMode ? "editTaskForm" : "createTaskForm"}">
                <div class="form-group">
                    <label for="taskTitle">Task Title *</label>
                    <input type="text" id="taskTitle" name="title" required maxlength="100" 
                           placeholder="Enter task title" value="${
                             task ? task.title : ""
                           }">
                </div>
                
                <div class="form-group">
                    <label for="taskDescription">Description</label>
                    <textarea id="taskDescription" name="description" rows="3" maxlength="500" 
                              placeholder="Enter task description">${
                                task ? task.description : ""
                              }</textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskPriority">Priority</label>
                        <select id="taskPriority" name="priority">
                            <option value="low" ${
                              task && task.priority === "low" ? "selected" : ""
                            }>Low</option>
                            <option value="medium" ${
                              !task || task.priority === "medium"
                                ? "selected"
                                : ""
                            }>Medium</option>
                            <option value="high" ${
                              task && task.priority === "high" ? "selected" : ""
                            }>High</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDueDate">Due Date</label>
                        <input type="date" id="taskDueDate" name="dueDate" 
                               value="${
                                 task && task.dueDate
                                   ? task.dueDate.split("T")[0]
                                   : ""
                               }">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="taskAssignTo">Assign To</label>
                    <select id="taskAssignTo" name="assignedTo">
                        <option value="">Unassigned (Visible to all)</option>
                        ${groupMembers
                          .map(
                            (member) => `
                            <option value="${member.id}" ${
                              task && task.assignedTo === member.id
                                ? "selected"
                                : ""
                            }>
                                ${member.name} ${
                              member.role === "admin" ? "üëë" : ""
                            }
                            </option>
                        `
                          )
                          .join("")}
                    </select>
                    <small class="assign-help">Unassigned tasks are visible to all group members. Assigned tasks are private.</small>
                </div>
                
                ${
                  isEditMode
                    ? `
                <div class="form-group">
                    <label for="taskStatus">Status</label>
                    <select id="taskStatus" name="status">
                        <option value="pending" ${
                          task.status === "pending" ? "selected" : ""
                        }>To Do</option>
                        <option value="in-progress" ${
                          task.status === "in-progress" ? "selected" : ""
                        }>In Progress</option>
                        <option value="completed" ${
                          task.status === "completed" ? "selected" : ""
                        }>Completed</option>
                    </select>
                </div>
                `
                    : ""
                }
                
                <div class="modal-actions">
                    <button type="button" class="btn-cancel">Cancel</button>
                    <button type="submit" class="btn-create">${
                      isEditMode ? "Update Task" : "Create Task"
                    }</button>
                </div>
            </form>
        </div>
    `;

          this.openModal(modal);

          // Set minimum date to today
          const dueDateInput = document.getElementById("taskDueDate");
          if (dueDateInput) {
            const today = new Date().toISOString().split("T")[0];
            dueDateInput.min = today;
          }
        }

        handleEditTask(e) {
          e.preventDefault();
          const formData = new FormData(e.target);

          const title = formData.get("title");
          const description = formData.get("description");
          const priority = formData.get("priority");
          const dueDate = formData.get("dueDate");
          const assignedTo = formData.get("assignedTo");
          const status = formData.get("status");

          if (!title.trim()) {
            this.showToast("Task title is required", "error");
            return;
          }

          const taskIndex = this.tasks.findIndex(
            (t) => t.id === this.editingTaskId
          );
          if (taskIndex === -1) {
            this.showToast("Task not found", "error");
            return;
          }

          const currentUser = this.getCurrentUser();
          const isUnassigned = !assignedTo || assignedTo.trim() === "";

          // Validate assigned user is still in group
          if (!isUnassigned) {
            const assignedMember = this.currentGroup.members.find(
              (m) => m.id === assignedTo
            );
            if (!assignedMember) {
              this.showToast(
                "Selected user is no longer in this group",
                "error"
              );

              // Auto-convert to unassigned
              this.tasks[taskIndex].assignedTo = null;
              this.tasks[taskIndex].assignedToName = "Unassigned";
              this.tasks[taskIndex].isUnassigned = true;
              this.saveTasks();
              this.renderTasks();
              this.showToast("Task converted to unassigned", "info");
              return;
            }
          }
        }

        // FIXED: Update status method
        updateTaskStatus(taskId, newStatus) {
          const task = this.tasks.find((t) => t.id === taskId);
          if (task) {
            task.status = newStatus;
            task.updatedAt = new Date().toISOString();
            this.saveTasks();
            this.renderTasks();
            this.showToast(`Task marked as ${newStatus}`, "success");
          }
        }

        // FIXED: Delete task with permission check
        deleteTask(taskId) {
          const task = this.tasks.find((t) => t.id === taskId);
          if (!task) return;

          // Check permissions
          const currentUser = this.getCurrentUser();
          const isCreator = task.createdBy === currentUser.id;

          // Find task's group
          const taskGroup = this.groups.find((g) => g.id === task.groupId);
          if (!taskGroup) return;

          const userRole = this.getUserRoleInGroup(
            taskGroup,
            currentUser.email
          );
          const isAdmin = userRole === "admin";

          // Only creator or admin can delete
          if (!isCreator && !isAdmin) {
            this.showToast(
              "You don't have permission to delete this task",
              "error"
            );
            return;
          }

          if (confirm("Are you sure you want to delete this task?")) {
            this.tasks = this.tasks.filter((t) => t.id !== taskId);
            this.saveTasks();
            this.renderTasks();
            this.showToast("Task deleted successfully", "success");
          }
        }

        getTasksByStatus(status) {
          const currentUser = this.getCurrentUser();
          const userId = currentUser.id;

          return this.tasks.filter((task) => {
            // Basic filters
            if (task.status !== status) return false;

            const taskGroup = this.groups.find((g) => g.id === task.groupId);
            if (!taskGroup) return false;

            // Check group membership
            const userRole = this.getUserRoleInGroup(
              taskGroup,
              currentUser.email
            );
            if (userRole === "non-member") return false;

            const isAdmin = userRole === "admin";
            const isAssigned = task.assignedTo && task.assignedTo.trim() !== "";
            const isAssignedToMe = task.assignedTo === userId;
            const isCreatedByMe = task.createdBy === userId;

            if (isAdmin) return true;

            if (!isAssigned) return true;

            return isAssignedToMe || isCreatedByMe;
          });
        }

        getTaskCounts() {
          return {
            pending: this.getTasksByStatus("pending").length,
            inProgress: this.getTasksByStatus("in-progress").length,
            completed: this.getTasksByStatus("completed").length,
          };
        }

        renderTasks() {
          const taskCounts = this.getTaskCounts();

          // Update task counts in the dashboard
          this.updateTaskCounts(taskCounts);

          // Render tasks for each status column
          this.renderTaskColumn("pending", this.getTasksByStatus("pending"));
          this.renderTaskColumn(
            "in-progress",
            this.getTasksByStatus("in-progress")
          );
          this.renderTaskColumn(
            "completed",
            this.getTasksByStatus("completed")
          );
        }

        updateTaskCounts(counts) {
          // Update the task count displays
          const pendingCount = document.querySelector(
            ".tasks-display:nth-child(1) span"
          );
          const inProgressCount = document.querySelector(
            ".tasks-display:nth-child(2) span"
          );
          const completedCount = document.querySelector(
            ".tasks-display:nth-child(3) span"
          );

          if (pendingCount) pendingCount.textContent = counts.pending;
          if (inProgressCount) inProgressCount.textContent = counts.inProgress;
          if (completedCount) completedCount.textContent = counts.completed;
        }

        renderTaskColumn(status, tasks) {
          const column = document.querySelector(
            `.tasks-display:nth-child(${this.getColumnIndex(status)})`
          );
          if (!column) return;

          const taskList =
            column.querySelector(".task-list") ||
            this.createTaskListElement(column);

          if (tasks.length === 0) {
            taskList.innerHTML = `<p class="empty">No ${status.replace(
              "-",
              " "
            )} tasks</p>`;
          } else {
            taskList.innerHTML = tasks
              .map((task) => this.renderTaskItem(task))
              .join("");
          }
        }

        getColumnIndex(status) {
          switch (status) {
            case "pending":
              return 1;
            case "in-progress":
              return 2;
            case "completed":
              return 3;
            default:
              return 1;
          }
        }

        createTaskListElement(column) {
          // Remove existing empty message
          const emptyMsg = column.querySelector(".empty");
          if (emptyMsg) emptyMsg.remove();

          // Create task list container
          const taskList = document.createElement("div");
          taskList.className = "task-list";
          column.appendChild(taskList);
          return taskList;
        }

        renderTaskItem(task) {
          const priorityClass = `priority-${task.priority}`;
          const isAssignedToMe = task.assignedTo === this.getCurrentUser().id;
          const canEdit =
            task.createdBy === this.getCurrentUser().id ||
            this.getUserRoleInGroup(
              this.currentGroup,
              this.getCurrentUser().email
            ) === "admin";

          return `
            <div class="task-item ${priorityClass}" data-task-id="${task.id}">
                <div class="task-header">
                    <h6 class="task-title">${task.title}</h6>
                    <div class="task-actions">
                        ${
                          canEdit
                            ? `
                            <button class="btn-task-edit" onclick="groupManager.editTask('${task.id}')">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button class="btn-task-delete" onclick="groupManager.deleteTask('${task.id}')">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        `
                            : ""
                        }
                    </div>
                </div>
                
                ${
                  task.description
                    ? `<p class="task-description">${task.description}</p>`
                    : ""
                }
                
                <div class="task-meta">
                    <span class="task-group">${task.groupName}</span>
                    <span class="task-assignee">
                        <i class="fa-solid fa-user"></i>
                        ${task.assignedToName}
                    </span>
                    ${
                      task.dueDate
                        ? `
                        <span class="task-due ${
                          this.isTaskOverdue(task) ? "overdue" : ""
                        }">
                            <i class="fa-solid fa-calendar"></i>
                            ${new Date(task.dueDate).toLocaleDateString()}
                        </span>
                    `
                        : ""
                    }
                </div>
                
                <div class="task-footer">
                    <span class="task-priority ${task.priority}">${
            task.priority
          }</span>
                    <div class="task-status-actions">
                        ${
                          task.status !== "pending"
                            ? `
                            <button class="btn-status" onclick="groupManager.updateTaskStatus('${task.id}', 'pending')">
                                To Do
                            </button>
                        `
                            : ""
                        }
                        ${
                          task.status !== "in-progress"
                            ? `
                            <button class="btn-status" onclick="groupManager.updateTaskStatus('${task.id}', 'in-progress')">
                                In Progress
                            </button>
                        `
                            : ""
                        }
                        ${
                          task.status !== "completed"
                            ? `
                            <button class="btn-status" onclick="groupManager.updateTaskStatus('${task.id}', 'completed')">
                                Complete
                            </button>
                        `
                            : ""
                        }
                    </div>
                </div>
            </div>
        `;
        }

        renderGroupTasksList(groupId) {
          const groupTasks = this.tasks.filter(
            (task) => task.groupId === groupId
          );

          if (groupTasks.length === 0) {
            return `<div class="empty-state"><p>No tasks in this group yet.</p></div>`;
          }

          return groupTasks
            .map(
              (task) => `
            <div class="group-task-item">
                <div class="group-task-main">
                    <h5>${task.title}</h5>
                    <span class="task-status-badge ${task.status}">${
                task.status
              }</span>
                </div>
                <div class="group-task-meta">
                    <span>Assigned to: ${task.assignedToName}</span>
                    <span>Priority: <span class="priority-${task.priority}">${
                task.priority
              }</span></span>
                    ${
                      task.dueDate
                        ? `<span>Due: ${new Date(
                            task.dueDate
                          ).toLocaleDateString()}</span>`
                        : ""
                    }
                </div>
            </div>
        `
            )
            .join("");
        }

        isTaskOverdue(task) {
          if (!task.dueDate) return false;
          return (
            new Date(task.dueDate) < new Date() && task.status !== "completed"
          );
        }

        // UTILITY METHODS
        validateGroupName(name) {
          const rules = [
            {
              test: name.length < 3,
              message: "Group name must be at least 3 characters long",
            },
            {
              test: name.length > 50,
              message: "Group name cannot exceed 50 characters",
            },
            {
              test: !/^[a-zA-Z0-9\s\-]+$/.test(name),
              message:
                "Group name can only contain letters, numbers, spaces, and hyphens",
            },
            {
              test: /^\s|\s$/.test(name),
              message: "Group name cannot start or end with spaces",
            },
            {
              test: /\s{2,}/.test(name),
              message: "Group name cannot contain consecutive spaces",
            },
            {
              test: this.groups.some(
                (group) => group.name.toLowerCase() === name.toLowerCase()
              ),
              message: "A group with this name already exists",
            },
          ];

          const violation = rules.find((rule) => rule.test);
          return violation
            ? { isValid: false, message: violation.message }
            : { isValid: true };
        }

        generateId() {
          return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        generateInvitationCode() {
          return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        getCurrentUser() {
          const userData = localStorage.getItem("user");
          if (userData) {
            try {
              const user = JSON.parse(userData);
              console.log("Retrieved user from localStorage:", user); // Debug log

              // Ensure we have the name property
              if (!user.name && user.fullname) {
                user.name = user.fullname;
              }

              return user;
            } catch (error) {
              console.error("Error parsing user data:", error);
            }
          }

          // Fallback for demo/dummy user
          return {
            id: "user123",
            name: "Demo User",
            email: "demo@example.com",
          };
        }

        saveGroups() {
          localStorage.setItem("taskflow_groups", JSON.stringify(this.groups));
        }

        saveTasks() {
          localStorage.setItem("taskflow_tasks", JSON.stringify(this.tasks));
        }

        renderGroups() {
          const groupsContainer = document.getElementById("groupsDisplay");
          if (!groupsContainer) return;

          const currentUser = this.getCurrentUser();

          // Get only groups where the user is a member
          const userGroups = this.groups.filter(
            (group) =>
              this.getUserRoleInGroup(group, currentUser.email) !== "non-member"
          );

          if (userGroups.length === 0) {
            groupsContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fa-solid fa-users" style="color: #365ee2; font-size: 3rem; margin-bottom: 1rem;"></i>
                    </div>
                    <h5>No Groups Yet</h5>
                    <p class="empty-message">You haven't joined any groups yet. Join an existing group or create your own to get started!</p>
                    <div class="empty-actions">
                        <button class="btn-primary" onclick="groupManager.openJoinGroupModal()">
                            <i class="fa-solid fa-arrow-right-to-bracket"></i>
                            Join a Group
                        </button>
                        <button class="btn-secondary" onclick="groupManager.openCreateGroupModal()">
                            <i class="fa-solid fa-plus"></i>
                            Create Group
                        </button>
                    </div>
                </div>
            `;
          } else {
            groupsContainer.innerHTML = userGroups
              .map((group) => {
                const userRole = this.getUserRoleInGroup(
                  group,
                  currentUser.email
                );
                const isMember = userRole !== "non-member";
                const isAdmin = userRole === "admin";
                const adminUser = group.members.find(
                  (member) => member.role === "admin"
                );
                const adminName = adminUser
                  ? adminUser.name || "Unknown Admin"
                  : "Unknown Admin";

                return `
                        <div class="group-item" data-group-id="${group.id}">
                            <div class="group-item-header">
                                <h5>${group.name} ${isAdmin ? "üëë" : ""}</h5>
                                <span class="member-count">${
                                  group.members.length
                                } member${
                  group.members.length !== 1 ? "s" : ""
                }</span>
                            </div>
                            ${
                              group.description
                                ? `
                                <div class="group-description">
                                    <strong>Description:</strong> ${group.description}
                                </div>
                            `
                                : ""
                            }
                            <div class="group-admin-info">
                                <small><strong>Admin:</strong> ${adminName}</small>
                            </div>
                            <div class="group-item-actions">
                                <span class="group-role">
                                    Your role: <strong>${userRole}</strong>
                                </span>
                                <span class="invitation-code">Code: ${
                                  group.invitationCode
                                }</span>
                            </div>
                            <div class="group-meta">
                                <small>Created: ${new Date(
                                  group.created
                                ).toLocaleDateString()}</small>
                            </div>
                        </div>
                    `;
              })
              .join("");

            // Add click listeners for user's groups only
            this.attachGroupClickListeners();
          }
        }

        attachGroupClickListeners() {
          const groupItems = document.querySelectorAll(
            ".group-item[data-group-id]"
          );

          groupItems.forEach((item) => {
            item.addEventListener("click", (e) => {
              const groupId = item.getAttribute("data-group-id");
              const group = this.groups.find((g) => g.id === groupId);

              if (group) {
                this.openGroupManagement(group);
              }
            });
          });
        }

        copyInvitationCode() {
          const codeElement = document.getElementById("invitationCode");
          if (!codeElement) return;

          const code = codeElement.textContent;
          navigator.clipboard.writeText(code).then(() => {
            this.showToast("Invitation code copied to clipboard!", "success");
          });
        }

        refreshInvitationCode() {
          this.currentGroup.invitationCode = this.generateInvitationCode();
          this.saveGroups();
          const codeElement = document.getElementById("invitationCode");
          if (codeElement) {
            codeElement.textContent = this.currentGroup.invitationCode;
          }
          this.showToast("New invitation code generated!", "success");
        }

        handleEditGroup(e) {
          e.preventDefault();
          const nameInput = document.getElementById("editGroupName");
          const descriptionInput = document.getElementById(
            "editGroupDescription"
          );

          if (!nameInput) return;

          const name = nameInput.value.trim();
          const description = descriptionInput
            ? descriptionInput.value.trim()
            : "";

          const validation = this.validateGroupName(name);
          if (!validation.isValid && name !== this.currentGroup.name) {
            alert(`Group name violation: ${validation.message}`);
            return;
          }

          this.currentGroup.name = name;
          this.currentGroup.description = description;
          this.saveGroups();
          this.renderGroups();
          this.openGroupManagement(this.currentGroup);
          this.showToast("Group updated successfully!", "success");
        }

        openModal(modal) {
          if (modal) {
            modal.style.display = "block";
            modal.style.animation = "fadeIn 0.3s ease";
            document.body.style.overflow = "hidden";
          }
        }

        closeModal(modal) {
          if (modal) {
            modal.style.display = "none";
            document.body.style.overflow = "auto";
          }
        }

        showConfirmation(title, message, callback) {
          let modal = document.getElementById("confirmationModal");
          if (!modal) {
            modal = document.createElement("div");
            modal.id = "confirmationModal";
            modal.className = "modal";
            document.body.appendChild(modal);
          }

          modal.innerHTML = `
            <div class="modal-content confirmation">
                <h3>${title}</h3>
                <p>${message}</p>
                <div class="modal-actions">
                    <button class="btn-cancel">Cancel</button>
                    <button class="btn-confirm">Confirm</button>
                </div>
            </div>
        `;

          // Use event delegation for confirmation buttons
          const confirmBtn = modal.querySelector(".btn-confirm");
          const cancelBtn = modal.querySelector(".btn-cancel");

          const confirmHandler = () => {
            callback();
            this.closeModal(modal);
          };

          const cancelHandler = () => {
            this.closeModal(modal);
          };

          confirmBtn.onclick = confirmHandler;
          cancelBtn.onclick = cancelHandler;

          this.openModal(modal);
        }
        // Enhanced showToast to handle task removal notifications
        showToast(message, type = "info", details = null) {
          const toast = document.createElement("div");
          toast.className = `toast toast-${type}`;

          let toastContent = message;
          if (details) {
            toastContent += `<br><small>${details}</small>`;
          }

          toast.innerHTML = toastContent;

          toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${
          type === "success"
            ? "#28a745"
            : type === "error"
            ? "#dc3545"
            : type === "warning"
            ? "#ffc107"
            : "#17a2b8"
        };
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideInRight 0.3s ease;
        max-width: 300px;
    `;

          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        }

        // Update removeUserTasksFromGroup to show notification
        removeUserTasksFromGroup(userId, groupId) {
          const initialTaskCount = this.tasks.length;
          let removedPersonalTasks = 0;

          this.tasks = this.tasks.filter((task) => {
            if (task.groupId !== groupId) return true;

            if (
              !task.assignedTo ||
              task.assignedTo === "Unassigned" ||
              task.assignedTo === null
            )
              return true;

            if (task.assignedTo !== userId) return true;

            if (task.createdBy === userId && task.assignedTo !== userId)
              return true;

            removedPersonalTasks++;
            return false;
          });

          if (removedPersonalTasks > 0) {
            this.showToast(
              `Tasks removed`,
              "info",
              `${removedPersonalTasks} assigned tasks were removed`
            );
          }

          return removedPersonalTasks;
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", function () {
        window.groupManager = new GroupManager();
      });
    </script>
  </body>
</html>
